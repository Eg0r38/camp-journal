<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>–ñ—É—Ä–Ω–∞–ª –≤–æ–∂–∞—Ç–æ–≥–æ ‚Ä¢ –∫–ª–∞—Å—Å–∏–∫–∞ + —É—Ä–æ–∫–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0078d4;
            --primary-dark: #005a9e;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --dark: #1a1f2e;
            --darker: #0f121c;
            --light: #2a2f3e;
            --lighter: #383e4e;
            --text: #eaeef2;
            --text-muted: #9aa4b8;
            --completed: #6f42c1;
            --bg-page: #0a0c14;
        }

        body {
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
            background: var(--bg-page);
            color: var(--text);
            padding: 12px 10px 70px 10px;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* —è—Ä–ª—ã–∫ –í–ñ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π */
        .vj-logo {
            position: fixed;
            top: 10px;
            left: 12px;
            width: 46px;
            height: 46px;
            background: var(--primary);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            color: white;
            box-shadow: 0 6px 14px rgba(0,120,212,0.5);
            z-index: 1100;
            border: 2px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(2px);
            transition: 0.2s;
        }
        .vj-logo:active { transform: scale(0.94); background: var(--primary-dark); }

        /* —é–∑–µ—Ä + —Å—Ç–∞—Ç—É—Å –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ —Å–ø—Ä–∞–≤–∞ */
        .top-bar {
            position: fixed;
            top: 10px;
            right: 12px;
            left: 70px;
            display: flex;
            gap: 6px;
            z-index: 1100;
            justify-content: flex-end;
            align-items: center;
            pointer-events: none;
        }
        .top-bar > * {
            pointer-events: auto;
        }
        .user-info {
            background: var(--dark);
            padding: 6px 12px 6px 10px;
            border-radius: 40px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--light);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            max-width: 200px;
        }
        .user-info span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .role-badge { background: var(--primary); padding: 3px 10px; border-radius: 30px; font-size: 10px; font-weight: 600; }
        .offline-badge { background: #ff9800; color: #000; padding: 3px 8px; border-radius: 30px; font-size: 10px; font-weight: bold; }

        .connection-status {
            background: #1e3a2a;
            color: #8bc34a;
            padding: 6px 14px;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid #2d4a36;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            white-space: nowrap;
        }
        .connection-status.offline { background: #3a1e1e; color: #f28b82; border-color: #4a2d2d; }

        /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .auth-card {
            background: var(--dark);
            border-radius: 32px;
            padding: 28px 20px;
            max-width: 400px;
            margin: 80px auto 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.7);
            border: 1px solid var(--light);
        }

        .auth-tabs {
            display: flex;
            gap: 6px;
            background: var(--darker);
            padding: 5px;
            border-radius: 40px;
            margin-bottom: 25px;
        }
        .auth-tab {
            flex: 1; padding: 12px 5px; border-radius: 40px; font-weight: 600; font-size: 15px;
            background: transparent; border: none; color: var(--text-muted);
        }
        .auth-tab.active { background: var(--primary); color: white; }

        /* –æ—Å–Ω–æ–≤–Ω–æ–π –∞–ø–ø –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .app-container {
            background: var(--dark);
            border-radius: 30px;
            padding: 20px 16px;
            margin-top: 80px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            border: 1px solid var(--light);
        }

        /* —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç */
        .sync-info {
            background: var(--darker);
            padding: 14px 18px;
            border-radius: 40px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--info);
            font-size: 15px;
        }
        .sync-info.offline-mode { border-color: var(--warning); }
        .sync-info button {
            width: auto; padding: 8px 18px; border-radius: 40px; font-size: 14px; margin: 0;
            background: var(--info); border: none; color: white; font-weight: 600;
        }
        .last-sync { font-size: 11px; color: var(--text-muted); text-align: right; margin-top: 4px; }

        /* –º–µ–Ω—é ‚Äî –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ 4 –∫–Ω–æ–ø–∫–∏ */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 20px 0 20px;
        }
        .menu-grid button {
            padding: 12px 4px;
            background: var(--light);
            border: 1px solid var(--lighter);
            border-radius: 22px;
            font-size: 13px;
            font-weight: 500;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.3;
            word-break: break-word;
        }

        /* –ø–æ–ª—è –≤–≤–æ–¥–∞ –ø–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω */
        input, select, textarea {
            width: 100%;
            padding: 16px 18px;
            margin: 5px 0;
            background: var(--light);
            border: 1px solid var(--lighter);
            border-radius: 40px;
            color: white;
            font-size: 16px;
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px 10px;
            border-radius: 40px;
            font-size: 16px;
            font-weight: 600;
            margin: 6px 0;
            width: 100%;
            transition: 0.15s;
            border: 1px solid var(--primary-dark);
        }
        button:active { transform: scale(0.97); background: var(--primary-dark); }

        .btn-success { background: var(--success); border-color: #218838; }
        .btn-danger { background: var(--danger); border-color: #c82333; }
        .btn-warning { background: var(--warning); color: #1a1a1a; border-color: #e0a800; }
        .btn-info { background: var(--info); border-color: #138496; }

        /* –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: var(--light);
            border-radius: 28px;
            padding: 18px 16px;
            margin-bottom: 14px;
            border: 1px solid var(--lighter);
        }

        .student-info {
            background: var(--darker);
            padding: 15px;
            border-radius: 24px;
            margin: 10px 0;
        }

        /* –æ—Ç–º–µ—Ç–∫–∏ */
        .mark-item {
            background: var(--lighter);
            border-radius: 30px;
            padding: 12px 18px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .mark-status { padding: 5px 16px; border-radius: 30px; font-weight: 600; font-size: 14px; }
        .mark-status.present { background: var(--success); }
        .mark-status.absent { background: var(--danger); }

        /* –∫–Ω–∏–≥–∏ */
        .book-item {
            background: var(--lighter);
            border-radius: 24px;
            padding: 16px;
            margin: 10px 0;
        }
        .book-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 12px;
        }
        .book-actions button { padding: 8px 0; font-size: 12px; margin: 0; }

        /* –º–æ–¥–∞–ª–∫–∏ */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000;
            display: none; align-items: center; justify-content: center; padding: 16px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--dark);
            border-radius: 40px;
            padding: 26px 20px;
            max-width: 480px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid var(--primary);
        }
        .close-btn { font-size: 32px; cursor: pointer; padding: 0 10px; }

        /* —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–¥–º–∏–Ω–∞ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 20px 0;
        }
        .stat-card {
            background: var(--darker);
            border-radius: 28px;
            padding: 15px 5px;
            text-align: center;
        }
        .stat-number { font-size: 28px; font-weight: 800; color: var(--primary); }

        /* —Ç–µ–≥–∏ */
        .student-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .student-tag {
            background: var(--darker);
            padding: 12px 18px;
            border-radius: 40px;
            font-size: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* —É—Ç–∏–ª–∏—Ç—ã */
        .flex-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .mb-20 { margin-bottom: 20px; }
        .text-muted { color: var(--text-muted); }

        /* —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        .page { display: none; margin-top: 8px; }
        .page.active { display: block; }

        /* –ø–æ–¥—Å–∫–∞–∑–∫–∞ */
        .admin-hint { text-align: center; margin-top: 20px; color: var(--text-muted); font-size: 13px; }
        .all-groups-section { margin-top: 30px; background: var(--darker); padding: 20px; border-radius: 40px; }
        .badge { padding: 4px 12px; border-radius: 30px; font-size: 11px; font-weight: 600; background: var(--primary); }

        /* —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –≥—Ä—É–ø–ø—ã */
        .group-date-edit {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--darker);
            padding: 5px 12px;
            border-radius: 40px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 8px;
        }
        .group-date-edit:hover { background: var(--light); }
        .date-input-inline {
            background: var(--darker);
            border: 1px solid var(--primary);
            padding: 8px 12px;
            border-radius: 30px;
            color: white;
            font-size: 14px;
            margin: 0 5px;
        }
        /* –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –¥–∞—Ç–∞ –æ—Ç–º–µ—Ç–∫–∏ */
        .mark-date-clickable {
            cursor: pointer;
            text-decoration: underline dotted;
            text-decoration-color: var(--info);
        }

        /* –ø–µ—Ä—Å–æ–Ω–∞–ª –≤ –∫–∞—Ä—Ç–æ—á–∫–µ */
        .staff-badge {
            background: var(--darker);
            padding: 6px 14px;
            border-radius: 30px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-right: 6px;
            margin-bottom: 6px;
            border: 1px solid var(--border);
        }
        .staff-badge.counselor { border-left: 3px solid var(--info); }
        .staff-badge.helper { border-left: 3px solid var(--warning); }
        
        .mark-item-small {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--darker);
            padding: 6px 12px;
            border-radius: 30px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
        }
        .mark-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .mark-status-dot.present { background: var(--success); }
        .mark-status-dot.absent { background: var(--danger); }

        /* —É—Ä–æ–∫–∏ */
        .lesson-badge {
            background: var(--completed);
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-right: 6px;
            margin-bottom: 6px;
            opacity: 0.9;
        }
        .lesson-badge.completed { background: var(--completed); }
        .lesson-badge.in-progress { background: var(--warning); color: #1a1a1a; }
        .lesson-badge.available { background: var(--success); }
    </style>
</head>
<body>
    <div class="vj-logo" onclick="showPage('groupsPage')">–í–ñ</div>

    <div class="top-bar">
        <div class="user-info" id="userInfo" style="display: none;">
            <span id="userName"></span>
            <span class="role-badge" id="userRole"></span>
            <span class="offline-badge" id="offlineBadge" style="display: none;">–æ—Ñ–ª–∞–π–Ω</span>
            <button onclick="logout()" style="width: auto; padding: 4px 12px; background: rgba(255,255,255,0.2); border: none;">‚§¥</button>
        </div>
        <div class="connection-status" id="connectionStatus" onclick="checkConnection()">üîÑ</div>
    </div>

    <!-- –º–æ–¥–∞–ª–∫–∏ -->
    <div class="modal" id="detailModal"><div class="modal-content"><div class="flex-row" style="justify-content:space-between"><h2 id="detailModalTitle"></h2><span class="close-btn" onclick="closeDetailModal()">‚úï</span></div><div id="detailModalBody"></div></div></div>
    <div class="modal" id="modal"><div class="modal-content"><div class="flex-row" style="justify-content:space-between"><h2 id="modalTitle"></h2><span class="close-btn" onclick="closeModal()">‚úï</span></div><div id="modalBody"></div></div></div>

    <!-- –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div id="authContainer">
        <div class="auth-card">
            <h2 class="text-center" style="margin-bottom:20px;">üìã –í–ñ</h2>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">–≤—Ö–æ–¥</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">—Ä–µ–≥–∏—Å—Ç—Ä</div>
            </div>
            <div id="loginForm">
                <input type="text" id="loginUsername" placeholder="–õ–æ–≥–∏–Ω">
                <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <button onclick="login()">üîì –≤–æ–π—Ç–∏</button>
            </div>
            <div id="registerForm" style="display:none;">
                <input type="text" id="registerUsername" placeholder="–õ–æ–≥–∏–Ω">
                <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <select id="registerRole"><option value="user">üë§ —é–∑–µ—Ä</option><option value="counselor">üë®‚Äçüè´ –≤–æ–∂–∞—Ç—ã–π</option><option value="helper">üÜò –ø–æ–º–æ—â–Ω–∏–∫</option></select>
                <button onclick="register()">üìù —Å–æ–∑–¥–∞—Ç—å</button>
            </div>
            <div class="admin-hint" onclick="fillAdminCredentials()">üëë –∞–¥–º–∏–Ω (–ï–≥–æ—Ä / 382154)</div>
        </div>
    </div>

    <!-- –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="appContainer" style="display:none;">
        <div class="app-container">
            <!-- –±–ª–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
            <div class="sync-info" id="syncInfo">
                <span id="syncStatus">üåê <span id="modeText">–æ–Ω–ª–∞–π–Ω</span></span>
                <button class="btn-info" onclick="forceSync()" id="syncButton">üîÑ —Å–∏–Ω—Ö—Ä.</button>
            </div>
            <div class="last-sync" id="lastSyncTime"></div>

            <!-- –º–µ–Ω—é 4x2 -->
            <div class="menu-grid" id="menuGrid"></div>

            <!-- —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–¥–º–∏–Ω–∞ -->
            <div id="adminStats" class="stats-grid" style="display:none;">
                <div class="stat-card"><div class="stat-number" id="totalGroupsStat">0</div><div>–≥—Ä—É–ø–ø</div></div>
                <div class="stat-card"><div class="stat-number" id="totalMembersStat">0</div><div>—É—á–∞—Å—Ç–Ω</div></div>
                <div class="stat-card"><div class="stat-number" id="totalMarksStat">0</div><div>–æ—Ç–º–µ—Ç–æ–∫</div></div>
                <div class="stat-card"><div class="stat-number" id="totalBooksStat">0</div><div>–∫–Ω–∏–≥</div></div>
                <div class="stat-card"><div class="stat-number" id="completedBooksStat">0</div><div>–ø—Ä–æ–π–¥</div></div>
            </div>

            <!-- –°–¢–†–ê–ù–ò–¶–´ -->
            <div class="page" id="groupsPage">
                <h2>üë• –≥—Ä—É–ø–ø—ã</h2>
                <div class="flex-row" style="margin-bottom:15px;"><input type="text" id="newGroupName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><button class="btn-success" style="width:auto; padding:16px 22px;" onclick="createGroup()">‚ûï</button></div>
                <div id="groupsList"></div>
                <div id="allGroupsSection" class="all-groups-section" style="display:none;"><h3>üëë –≤—Å–µ –≥—Ä—É–ø–ø—ã</h3><div id="allGroupsList"></div></div>
            </div>

            <div class="page" id="studentsPage">
                <h2>üë§ —É—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
                <div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:12px;">
                    <input type="text" id="newStudentName" placeholder="–ò–º—è" style="flex:2;">
                    <input type="date" id="newStudentBirthday" style="flex:1.5;">
                    <input type="text" id="newStudentPhone" placeholder="—Ç–µ–ª." style="flex:1.5;">
                    <input type="text" id="newStudentParentPhone" placeholder="—Ç–µ–ª.—Ä–æ–¥." style="flex:1.5;">
                    <select id="studentGroupSelect" style="flex:1.5;"></select>
                    <button class="btn-success" style="width:100%;" onclick="addStudent()">‚ûï –¥–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div id="studentsList"></div>
            </div>

            <div class="page" id="marksPage">
                <h2>‚≠ê –æ—Ç–º–µ—Ç–∫–∏</h2>
                <div class="flex-row" style="margin-bottom:10px;">
                    <select id="markGroupSelect" onchange="updateStudentSelect()" style="flex:1;"></select>
                    <select id="markStudentSelect" style="flex:1;"></select>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
                    <button class="btn-present" onclick="addMark('present')">‚úÖ –ø—Ä–∏—Å—É—Ç.</button>
                    <button class="btn-absent" onclick="addMark('absent')">‚ùå –æ—Ç—Å—É—Ç.</button>
                </div>
                <div id="marksList" style="margin-top:20px;"></div>
            </div>

            <div class="page" id="activitiesPage">
                <h2>üìã –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h2>
                <div class="flex-row"><input type="text" id="newActivityName" placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ"><input type="date" id="activityDate"><button class="btn-success" style="width:auto;" onclick="addActivity()">‚ûï</button></div>
                <div id="activitiesList"></div>
            </div>

            <div class="page" id="counselorsPage"><h2>üë®‚Äçüè´ –≤–æ–∂–∞—Ç—ã–µ</h2><div class="flex-row"><input id="newCounselorName" placeholder="–∏–º—è"><select id="counselorGroupSelect"></select><button class="btn-success" onclick="addCounselor()">‚ûï</button></div><div id="counselorsList"></div></div>
            <div class="page" id="helpersPage"><h2>üÜò –ø–æ–º–æ—â–Ω–∏–∫–∏</h2><div class="flex-row"><input id="newHelperName" placeholder="–∏–º—è"><select id="helperGroupSelect"></select><button class="btn-success" onclick="addHelper()">‚ûï</button></div><div id="helpersList"></div></div>

            <div class="page" id="booksPage">
                <h2>üìö –∫–Ω–∏–≥–∏</h2>
                <div class="flex-row"><input id="newBookTitle" placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ"><input id="newBookLesson" placeholder="—É—Ä–æ–∫"><select id="bookStatus"><option value="available">üìñ –¥–æ—Å—Ç—É–ø–Ω–∞</option><option value="in-progress">üìö –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</option><option value="completed">‚úÖ –ø—Ä–æ–π–¥–µ–Ω–∞</option></select><button class="btn-success" onclick="addBook()">‚ûï</button></div>
                <div class="flex-row" style="margin:15px 0;">
                    <button style="flex:1; padding:12px;" onclick="filterBooks('all')">–≤—Å–µ</button>
                    <button style="flex:1; background:var(--success)" onclick="filterBooks('available')">–¥–æ—Å—Ç—É–ø–Ω</button>
                    <button style="flex:1; background:var(--warning)" onclick="filterBooks('in-progress')">–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</button>
                    <button style="flex:1; background:var(--completed)" onclick="filterBooks('completed')">–ø—Ä–æ–π–¥</button>
                </div>
                <div id="booksList"></div>
            </div>

            <div class="page" id="adminPage">
                <h2>‚öôÔ∏è —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                <div class="card"><h3>üìä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3><div class="flex-row"><span>–≤—Å–µ–≥–æ: <span id="totalUsers">0</span></span><span>–∞–¥–º–∏–Ω–æ–≤: <span id="adminCount">0</span></span><span>–≤–æ–∂–∞—Ç—ã—Ö: <span id="counselorCount">0</span></span></div></div>
                <div id="usersList"></div>
                <div class="cleanup-section" style="margin-top:30px; background:var(--darker); padding:20px; border-radius:40px;">
                    <h3 style="color:var(--danger)">üóëÔ∏è –æ—á–∏—Å—Ç–∫–∞</h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
                        <button class="btn-warning" onclick="cleanupData('empty-groups')">–ø—É—Å—Ç—ã–µ –≥—Ä—É–ø–ø—ã</button>
                        <button class="btn-warning" onclick="cleanupData('orphaned-marks')">–æ—Ç–º–µ—Ç–∫–∏ –±–µ–∑ —É—á.</button>
                        <button class="btn-warning" onclick="cleanupData('old-activities')">—Å—Ç–∞—Ä—ã–µ –º–µ—Ä–æ–ø—Ä.</button>
                        <button class="btn-danger" onclick="cleanupData('all')">–≤—Å—ë</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï ==========
        let currentUser = null;
        let token = localStorage.getItem('token');
        let data = { groups: {}, members: {}, marks: {}, activities: {}, counselors: {}, helpers: {}, books: { list: [] }, allUsersData: {} };
        let isOnline = true;
        let pendingChanges = false;
        let lastSyncTime = localStorage.getItem('lastSyncTime') || null;
        let currentBookFilter = 'all';

        // --- —Ñ—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ---
        function showToast(msg, type = 'info') {
            alert(msg);
        }

        function saveToLocalStorage() {
            if (currentUser) {
                localStorage.setItem(`userData_${currentUser.id}`, JSON.stringify({ user: currentUser, data, timestamp: new Date().toISOString() }));
                localStorage.setItem('localData', JSON.stringify(data));
                localStorage.setItem('lastUser', JSON.stringify(currentUser));
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('lastUser');
            if (saved && !currentUser) { try { currentUser = JSON.parse(saved); document.getElementById('userName').textContent = currentUser?.username; } catch (e) {} }
            const local = localStorage.getItem('localData'); if (local) { try { data = JSON.parse(local); renderAll(); } catch (e) {} }
            if (lastSyncTime) document.getElementById('lastSyncTime').textContent = `üïí —Å–∏–Ω—Ö—Ä: ${new Date(lastSyncTime).toLocaleString()}`;
        }

        // --- –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ---
        async function checkConnection() {
            try {
                const res = await fetch('/api/health', { method:'HEAD', cache:'no-store' }).catch(()=>{ throw new Error() });
                if (res && res.ok) {
                    isOnline = true;
                    document.getElementById('connectionStatus').textContent = 'üü¢ –æ–Ω–ª–∞–π–Ω';
                    document.getElementById('connectionStatus').classList.remove('offline');
                    document.getElementById('offlineBadge').style.display = 'none';
                    document.getElementById('modeText').textContent = '–æ–Ω–ª–∞–π–Ω';
                    if (pendingChanges) autoSync();
                    return true;
                } else throw new Error();
            } catch {
                isOnline = false;
                document.getElementById('connectionStatus').textContent = 'üî¥ –æ—Ñ–ª–∞–π–Ω';
                document.getElementById('connectionStatus').classList.add('offline');
                document.getElementById('offlineBadge').style.display = 'inline-block';
                document.getElementById('modeText').textContent = '–æ—Ñ–ª–∞–π–Ω';
                return false;
            }
        }

        async function autoSync() {
            if (!currentUser || !token || !isOnline) return false;
            try {
                const response = await fetch('/api/sync', { method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`}, body:JSON.stringify(data) });
                if (response.ok) {
                    pendingChanges = false;
                    lastSyncTime = new Date().toISOString(); localStorage.setItem('lastSyncTime', lastSyncTime);
                    document.getElementById('lastSyncTime').textContent = `üïí —Å–∏–Ω—Ö—Ä: ${new Date(lastSyncTime).toLocaleString()}`;
                    await loadData(); return true;
                }
            } catch (e) { console.log('autoSync err', e); } return false;
        }

        async function forceSync() {
            if (!currentUser) return showToast('–≤–æ–π–¥–∏—Ç–µ','error');
            if (!isOnline) return showToast('–Ω–µ—Ç wifi','error');
            showToast('üîÑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...');
            if (await autoSync()) showToast('‚úÖ –≥–æ—Ç–æ–≤–æ','success'); else showToast('‚ùå –æ—à–∏–±–∫–∞','error');
        }

        setInterval(checkConnection, 10000);
        checkConnection();

        // --- –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ---
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));
            if (tab==='login') { document.querySelectorAll('.auth-tab')[0].classList.add('active'); document.getElementById('loginForm').style.display='block'; document.getElementById('registerForm').style.display='none'; }
            else { document.querySelectorAll('.auth-tab')[1].classList.add('active'); document.getElementById('loginForm').style.display='none'; document.getElementById('registerForm').style.display='block'; }
        }
        function fillAdminCredentials() { document.getElementById('loginUsername').value='–ï–≥–æ—Ä'; document.getElementById('loginPassword').value='382154'; showToast('–∞–¥–º–∏–Ω –≤–≤–µ–¥—ë–Ω','success'); }

        async function register() {
            const u = document.getElementById('registerUsername').value.trim(), p = document.getElementById('registerPassword').value, r = document.getElementById('registerRole').value;
            if (!u||!p) return showToast('–∑–∞–ø–æ–ª–Ω–∏—Ç–µ','error');
            if (!isOnline) return showToast('–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞','error');
            try {
                const res = await fetch('/api/register',{ method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p,role:r}) });
                const d = await res.json();
                if (res.ok) { showToast('‚úÖ –æ–∫','success'); switchAuthTab('login'); } else showToast(d.error||'–æ—à–∏–±–∫–∞','error');
            } catch { showToast('–æ—à–∏–±–∫–∞','error'); }
        }

        async function login() {
            const u = document.getElementById('loginUsername').value.trim(), p = document.getElementById('loginPassword').value;
            if (!u||!p) return showToast('–≤–≤–µ–¥–∏—Ç–µ','error');
            if (!isOnline) {
                const saved = localStorage.getItem('lastUser');
                if (saved) { try { const us = JSON.parse(saved); if (us.username===u) { currentUser=us; token=localStorage.getItem('token'); showApp(); showToast('–æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º','warning'); return; } } catch(e){} }
                return showToast('–Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞','error');
            }
            try {
                const res = await fetch('/api/login',{ method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p}) });
                const d = await res.json();
                if (res.ok) { token = d.token; currentUser = d.user; localStorage.setItem('token',token); await loadData(); showApp(); showToast(`üëã ${u}`,'success'); }
                else showToast(d.error||'–æ—à–∏–±–∫–∞','error');
            } catch { showToast('–æ—à–∏–±–∫–∞','error'); }
        }

        function logout() { saveToLocalStorage(); currentUser=null; token=null; localStorage.removeItem('token'); document.getElementById('authContainer').style.display='block'; document.getElementById('appContainer').style.display='none'; document.getElementById('userInfo').style.display='none'; }

        function showApp() {
            document.getElementById('authContainer').style.display='none'; document.getElementById('appContainer').style.display='block'; document.getElementById('userInfo').style.display='flex';
            document.getElementById('userName').textContent = currentUser?.username;
            const roleNames={'admin':'–ê–¥–º–∏–Ω','counselor':'–í–æ–∂–∞—Ç—ã–π','helper':'–ü–æ–º–æ—â–Ω–∏–∫','user':'–Æ–∑–µ—Ä'};
            document.getElementById('userRole').textContent = roleNames[currentUser?.role]||currentUser?.role;
            if (currentUser?.role==='admin') document.getElementById('adminStats').style.display='grid';
            updateMenu(); showPage('studentsPage');
        }

        function updateMenu() {
            const r = currentUser?.role;
            let btns = '<button onclick="showPage(\'groupsPage\')">üë• –≥—Ä—É–ø–ø—ã</button><button onclick="showPage(\'studentsPage\')">üë§ —É—á–∞—Å—Ç–Ω–∏–∫–∏</button><button onclick="showPage(\'marksPage\')">‚≠ê –æ—Ç–º–µ—Ç–∫–∏</button><button onclick="showPage(\'activitiesPage\')">üìã –º–µ—Ä–æ–ø—Ä</button>';
            if (r==='admin') btns += '<button onclick="showPage(\'counselorsPage\')">üë®‚Äçüè´ –≤–æ–∂–∞—Ç—ã–µ</button><button onclick="showPage(\'helpersPage\')">üÜò –ø–æ–º–æ—â–Ω–∏–∫–∏</button><button onclick="showPage(\'booksPage\')">üìö –∫–Ω–∏–≥–∏</button><button onclick="showPage(\'adminPage\')">‚öôÔ∏è –∞–¥–º–∏–Ω</button>';
            document.getElementById('menuGrid').innerHTML = btns;
        }

        function showPage(p) {
            document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
            document.getElementById(p).classList.add('active');
            if (p==='adminPage' && currentUser?.role==='admin') loadUsers();
            if (p==='groupsPage' && currentUser?.role==='admin') { document.getElementById('allGroupsSection').style.display='block'; renderAllGroups(); } else document.getElementById('allGroupsSection').style.display='none';
            if (p==='booksPage') renderBooks();
            updatePageControls(p);
        }

        function updatePageControls(p) {
            if (p==='marksPage') { updateGroupSelects(); updateStudentSelect(); }
            else if (p==='studentsPage'||p==='counselorsPage'||p==='helpersPage') updateGroupSelects();
        }

        async function loadData() {
            if (!token) return;
            try {
                const res = await fetch('/api/data',{ headers:{'Authorization':`Bearer ${token}`} });
                if (res.ok) {
                    const serverData = await res.json();
                    if (currentUser?.role==='admin') { 
                        data = { 
                            groups: serverData.myData?.groups||{}, 
                            members: serverData.myData?.members||{}, 
                            marks: serverData.myData?.marks||{}, 
                            activities: serverData.myData?.activities||{}, 
                            counselors: serverData.myData?.counselors||{}, 
                            helpers: serverData.myData?.helpers||{}, 
                            books: serverData.myData?.books||{list:[]}, 
                            allUsersData: serverData.allUsersData||{} 
                        };
                    } else {
                        data = { groups: serverData.groups||{}, members: serverData.members||{}, marks: serverData.marks||{}, activities: serverData.activities||{}, counselors: serverData.counselors||{}, helpers: serverData.helpers||{}, books: serverData.books||{list:[]} };
                    }
                    for (let g in data.groups) {
                        if (!data.groups[g].createdAt) data.groups[g].createdAt = new Date().toISOString();
                    }
                    renderAll(); saveToLocalStorage();
                }
            } catch { loadFromLocalStorage(); }
        }

        async function saveData() {
            saveToLocalStorage(); pendingChanges = true;
            if (isOnline) { try { await fetch('/api/data',{ method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`}, body:JSON.stringify(data) }); pendingChanges = false; lastSyncTime = new Date().toISOString(); localStorage.setItem('lastSyncTime',lastSyncTime); document.getElementById('lastSyncTime').textContent = `üïí —Å–∏–Ω—Ö—Ä: ${new Date(lastSyncTime).toLocaleString()}`; } catch (e) { showToast('üì± –ª–æ–∫–∞–ª—å–Ω–æ','warning'); } } else showToast('üì± —Å–æ—Ö—Ä. –ª–æ–∫–∞–ª—å–Ω–æ','info');
        }

        // ========== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –î–ê–¢ ==========
        window.editGroupDate = function(groupName) {
            const currentDate = data.groups[groupName]?.createdAt ? new Date(data.groups[groupName].createdAt).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
            const modalBody = `
                <div style="text-align:center; margin:20px 0;">
                    <label style="display:block; margin-bottom:10px;">üìÖ –ù–æ–≤–∞—è –¥–∞—Ç–∞ –≥—Ä—É–ø–ø—ã <strong>${groupName}</strong></label>
                    <input type="date" id="editGroupDateInput" value="${currentDate}" style="width:100%; padding:16px; border-radius:40px; background:var(--light); border:1px solid var(--primary);">
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button class="btn-success" style="flex:1;" onclick="saveGroupDate('${groupName}')">üíæ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="btn-danger" style="flex:1;" onclick="closeModal()">–æ—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            `;
            document.getElementById('modalTitle').textContent = '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –≥—Ä—É–ø–ø—ã';
            document.getElementById('modalBody').innerHTML = modalBody;
            document.getElementById('modal').classList.add('active');
        };

        window.saveGroupDate = function(groupName) {
            const newDateStr = document.getElementById('editGroupDateInput').value;
            if (!newDateStr) return showToast('–≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É','error');
            const newDate = new Date(newDateStr + 'T00:00:00.000Z');
            if (isNaN(newDate.getTime())) return showToast('–Ω–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞','error');
            data.groups[groupName].createdAt = newDate.toISOString();
            saveData().then(() => {
                closeModal();
                renderGroups();
                showToast('‚úÖ –¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞','success');
            });
        };

        window.editMarkDate = function(group, studentId, markId) {
            const mark = data.marks[group]?.[studentId]?.find(m => m.id === markId);
            if (!mark) return showToast('–æ—Ç–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','error');
            const currentDate = mark.date ? new Date(mark.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
            const modalBody = `
                <div style="text-align:center; margin:20px 0;">
                    <label style="display:block; margin-bottom:10px;">üìÖ –ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ—Ç–º–µ—Ç–∫–∏</label>
                    <input type="date" id="editMarkDateInput" value="${currentDate}" style="width:100%; padding:16px; border-radius:40px; background:var(--light); border:1px solid var(--primary);">
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button class="btn-success" style="flex:1;" onclick="saveMarkDate('${group}', '${studentId}', ${markId})">üíæ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="btn-danger" style="flex:1;" onclick="closeModal()">–æ—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            `;
            document.getElementById('modalTitle').textContent = '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –æ—Ç–º–µ—Ç–∫–∏';
            document.getElementById('modalBody').innerHTML = modalBody;
            document.getElementById('modal').classList.add('active');
        };

        window.saveMarkDate = function(group, studentId, markId) {
            const newDateStr = document.getElementById('editMarkDateInput').value;
            if (!newDateStr) return showToast('–≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É','error');
            const newDate = new Date(newDateStr + 'T00:00:00.000Z');
            if (isNaN(newDate.getTime())) return showToast('–Ω–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞','error');
            const mark = data.marks[group]?.[studentId]?.find(m => m.id === markId);
            if (!mark) return showToast('–æ—Ç–º–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','error');
            mark.date = newDate.toISOString();
            saveData().then(() => {
                closeModal();
                renderMarks();
                showToast('‚úÖ –¥–∞—Ç–∞ –æ—Ç–º–µ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞','success');
            });
        };

        // --- –æ—Å–Ω–æ–≤–Ω—ã–µ CRUD ---
        window.createGroup = async function() {
            const name = document.getElementById('newGroupName').value.trim();
            if (!name) return showToast('–≤–≤–µ–¥–∏—Ç–µ','error');
            if (!isOnline) return showToast('–æ—Ñ–ª–∞–π–Ω –Ω–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å','error');
            try {
                const res = await fetch('/api/groups',{ method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`}, body:JSON.stringify({name}) });
                if (res.ok) { showToast('‚úÖ','success'); document.getElementById('newGroupName').value=''; await loadData(); } else showToast('–æ—à–∏–±–∫–∞','error');
            } catch { showToast('–æ—à–∏–±–∫–∞','error'); }
        };
        window.deleteGroup = async function(name) { if (!confirm('—É–¥–∞–ª–∏—Ç—å?')) return; if (!isOnline) return showToast('—Ç–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω','error'); try { await fetch(`/api/groups/${encodeURIComponent(name)}`,{ method:'DELETE',headers:{'Authorization':`Bearer ${token}`}}); showToast('—É–¥–∞–ª–µ–Ω–æ','success'); await loadData(); } catch { showToast('error','error'); } };

        function addStudent() {
            const name = document.getElementById('newStudentName').value.trim(), birthday = document.getElementById('newStudentBirthday').value, phone = document.getElementById('newStudentPhone').value, parentPhone = document.getElementById('newStudentParentPhone').value, group = document.getElementById('studentGroupSelect').value;
            if (!name||!group) return showToast('–∏–º—è –∏ –≥—Ä—É–ø–ø–∞','error');
            if (!data.members[group]) data.members[group] = [];
            data.members[group].push({ id: Date.now(), name, birthday: birthday||null, phone: phone||null, parentPhone: parentPhone||null, addedAt: new Date().toISOString() });
            saveData().then(()=>{ document.getElementById('newStudentName').value=''; document.getElementById('newStudentBirthday').value=''; document.getElementById('newStudentPhone').value=''; document.getElementById('newStudentParentPhone').value=''; renderStudents(); updateStats(); showToast('‚úÖ','success'); });
        }
        window.removeStudent = function(g, sid) { if (!confirm('—É–¥–∞–ª–∏—Ç—å?')) return; data.members[g] = data.members[g].filter(s => s.id !== sid); saveData().then(()=>{ renderStudents(); updateStats(); }); };

        function updateStudentSelect() {
            const group = document.getElementById('markGroupSelect').value, studSel = document.getElementById('markStudentSelect');
            if (!group || !data.members[group]?.length) { studSel.innerHTML = '<option value="">–Ω–µ—Ç</option>'; return; }
            let opts = '<option value="">—É—á–∞—Å—Ç–Ω–∏–∫</option>';
            data.members[group].forEach(s => opts += `<option value="${s.id}">${s.name}</option>`);
            studSel.innerHTML = opts;
        }
        window.addMark = function(status) {
            const group = document.getElementById('markGroupSelect').value, studentId = document.getElementById('markStudentSelect').value;
            if (!group||!studentId) return showToast('–≤—ã–±–µ—Ä–∏—Ç–µ','error');
            if (!data.marks[group]) data.marks[group] = {};
            if (!data.marks[group][studentId]) data.marks[group][studentId] = [];
            data.marks[group][studentId].push({ id: Date.now(), status, date: new Date().toISOString(), author: currentUser?.username });
            saveData().then(()=>{ renderMarks(); updateStats(); });
        };
        window.deleteMark = function(g, sid, mid) { if (!confirm('—É–¥–∞–ª–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É?')) return; const idx = data.marks[g][sid].findIndex(m=>m.id===mid); if (idx!==-1) { data.marks[g][sid].splice(idx,1); if (!data.marks[g][sid].length) delete data.marks[g][sid]; if (!Object.keys(data.marks[g]).length) delete data.marks[g]; saveData().then(()=>{ renderMarks(); updateStats(); }); } };

        function addActivity() { const n=document.getElementById('newActivityName').value.trim(), d=document.getElementById('activityDate').value; if(!n||!d) return showToast('–ø–æ–ª—è','error'); if(!data.activities[d]) data.activities[d]=[]; data.activities[d].push({id:Date.now(),name:n}); saveData().then(()=>{ document.getElementById('newActivityName').value=''; renderActivities(); }); }
        function addCounselor() { const n=document.getElementById('newCounselorName').value.trim(), g=document.getElementById('counselorGroupSelect').value; if(!n||!g) return showToast('–ø–æ–ª—è','error'); if(!data.counselors[g]) data.counselors[g]=[]; data.counselors[g].push({id:Date.now(),name:n}); saveData().then(()=>{ document.getElementById('newCounselorName').value=''; renderCounselors(); }); }
        function addHelper() { const n=document.getElementById('newHelperName').value.trim(), g=document.getElementById('helperGroupSelect').value; if(!n||!g) return; if(!data.helpers[g]) data.helpers[g]=[]; data.helpers[g].push({id:Date.now(),name:n}); saveData().then(()=>{ document.getElementById('newHelperName').value=''; renderHelpers(); }); }
        window.removeCounselor = function(g,id) { if(!confirm('—É–¥–∞–ª–∏—Ç—å?')) return; data.counselors[g]=data.counselors[g].filter(c=>c.id!==id); saveData().then(renderCounselors); };
        window.removeHelper = function(g,id) { if(!confirm('—É–¥–∞–ª–∏—Ç—å?')) return; data.helpers[g]=data.helpers[g].filter(h=>h.id!==id); saveData().then(renderHelpers); };
        function addBook() { const t=document.getElementById('newBookTitle').value.trim(), l=document.getElementById('newBookLesson').value.trim(), s=document.getElementById('bookStatus').value; if(!t||!l) return; data.books.list.push({id:Date.now(),title:t,lesson:l,status:s}); saveData().then(()=>{ document.getElementById('newBookTitle').value=''; document.getElementById('newBookLesson').value=''; renderBooks(); updateStats(); }); }
        window.updateBookStatus = function(bid,ns) { const b=data.books.list.find(b=>b.id===bid); if(b){ b.status=ns; saveData().then(renderBooks); }};
        window.deleteBook = function(bid) { if(!confirm('—É–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É?')) return; data.books.list = data.books.list.filter(b=>b.id!==bid); saveData().then(renderBooks); };
        window.filterBooks = function(f) { currentBookFilter=f; renderBooks(); };

        // --- —Ä–µ–Ω–¥–µ—Ä—ã ---
        function renderAll() { renderGroups(); renderStudents(); renderMarks(); renderActivities(); renderCounselors(); renderHelpers(); renderBooks(); updateGroupSelects(); updateStats(); if(currentUser?.role==='admin') renderAllGroups(); }
        
        function renderGroups() {
            const gl=document.getElementById('groupsList');
            if (!Object.keys(data.groups||{}).length) { gl.innerHTML='<div class="no-data">–Ω–µ—Ç –≥—Ä—É–ø–ø</div>'; return; }
            let html='';
            for (let n in data.groups) {
                const createdAt = data.groups[n].createdAt ? new Date(data.groups[n].createdAt).toLocaleDateString() : '–Ω–µ —É–∫–∞–∑–∞–Ω–∞';
                html+=`
                    <div class="card">
                        <div class="flex-row" style="justify-content:space-between">
                            <strong>${n}</strong>
                            ${currentUser?.role==='admin'?`
                                <div style="display:flex; gap:4px;">
                                    <button class="btn-info" style="width:auto; padding:6px 16px;" onclick="editGroupDate('${n}')">‚úèÔ∏è</button>
                                    <button class="btn-danger" style="width:auto; padding:6px 16px;" onclick="deleteGroup('${n}')">‚úï</button>
                                </div>
                            `:''}
                        </div>
                        <div>üë• ${data.members?.[n]?.length||0}</div>
                        <div class="group-date-edit" onclick="editGroupDate('${n}')">
                            üìÖ ${createdAt} <span style="color:var(--info);">(—Ä–µ–¥.)</span>
                        </div>
                    </div>
                `;
            }
            gl.innerHTML = html;
        }

        // ========== –ì–õ–ê–í–ù–û–ï: –û–¢–†–ò–°–û–í–ö–ê –£–ß–ê–°–¢–ù–ò–ö–û–í –° –£–†–û–ö–ê–ú–ò ==========
        function renderStudents() {
            const st=document.getElementById('studentsList');
            if(!Object.keys(data.members||{}).length) { st.innerHTML='<div class="no-data">–Ω–µ—Ç</div>'; return; }
            let h='';
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ (—Å—Ç–∞—Ç—É—Å completed)
            const completedBooks = data.books?.list?.filter(b => b.status === 'completed') || [];
            
            for(let g in data.members) {
                if(!data.members[g].length) continue;
                const groupCounselors = data.counselors?.[g] || [];
                const groupHelpers = data.helpers?.[g] || [];
                
                data.members[g].forEach(s=>{
                    const studentMarks = data.marks?.[g]?.[s.id] || [];
                    const lastMarks = studentMarks.slice(-5).reverse();
                    
                    h+=`
                        <div class="card">
                            <div class="flex-row" style="justify-content:space-between">
                                <strong>${s.name}</strong>
                                <span class="badge">${g}</span>
                            </div>
                            
                            <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                            <div style="margin:10px 0; padding:10px; background:var(--darker); border-radius:20px;">
                                ${s.birthday?`<div>üìÖ –î–†: ${new Date(s.birthday).toLocaleDateString()}</div>`:''}
                                ${s.phone?`<div>üìû ${s.phone}</div>`:''}
                                ${s.parentPhone?`<div>üë™ ${s.parentPhone}</div>`:''}
                            </div>
                            
                            <!-- –í–æ–∂–∞—Ç—ã–µ –∏ –ø–æ–º–æ—â–Ω–∏–∫–∏ -->
                            <div style="margin:10px 0;">
                                ${groupCounselors.map(c=>`<span class="staff-badge counselor">üë®‚Äçüè´ ${c.name}</span>`).join('')}
                                ${groupHelpers.map(h=>`<span class="staff-badge helper">üÜò ${h.name}</span>`).join('')}
                                ${groupCounselors.length===0 && groupHelpers.length===0 ? '<span class="text-muted">–Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∞</span>' : ''}
                            </div>
                            
                            <!-- –ü–†–û–ô–î–ï–ù–ù–´–ï –£–†–û–ö–ò (–∫–Ω–∏–≥–∏) -->
                            <div style="margin:15px 0;">
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                    <span>üìö –ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ —É—Ä–æ–∫–∏:</span>
                                    <span class="lesson-badge completed">${completedBooks.length} —à—Ç.</span>
                                </div>
                                <div style="display:flex; flex-wrap:wrap; gap:6px;">
                                    ${completedBooks.map(book => `
                                        <span class="lesson-badge completed" title="${book.lesson}">
                                            ‚úÖ ${book.title} (${book.lesson})
                                        </span>
                                    `).join('')}
                                    ${completedBooks.length === 0 ? '<span class="text-muted">–Ω–µ—Ç –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤</span>' : ''}
                                </div>
                            </div>
                            
                            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–º–µ—Ç–∫–∏ -->
                            <div style="margin:15px 0;">
                                <div style="margin-bottom:8px;">‚≠ê –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–º–µ—Ç–∫–∏:</div>
                                ${lastMarks.map(m=>`
                                    <span class="mark-item-small" onclick="editMarkDate('${g}', ${s.id}, ${m.id})">
                                        <span class="mark-status-dot ${m.status}"></span>
                                        ${new Date(m.date).toLocaleDateString()}
                                        ${m.status==='present'?'‚úÖ':'‚ùå'}
                                    </span>
                                `).join('')}
                                ${lastMarks.length===0?'<span class="text-muted">–Ω–µ—Ç –æ—Ç–º–µ—Ç–æ–∫</span>':''}
                            </div>
                            
                            <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                            <button class="btn-danger" style="width:auto; padding:8px 16px; margin-top:10px;" onclick="removeStudent('${g}',${s.id})">‚úï —É–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `;
                });
            }
            st.innerHTML = h;
        }
        
        function renderMarks() {
            const ml=document.getElementById('marksList');
            if(!Object.keys(data.marks||{}).length) { ml.innerHTML='<div class="no-data">–Ω–µ—Ç</div>'; return; }
            let h='';
            for(let g in data.marks) {
                for(let sid in data.marks[g]) {
                    let s = data.members[g]?.find(m=>m.id==sid);
                    if(!s) continue;
                    h+=`<div class="card"><strong>${s.name} (${g})</strong>`;
                    data.marks[g][sid].slice().reverse().forEach(m=>{
                        h+=`
                            <div class="mark-item">
                                <span class="mark-status ${m.status}">${m.status==='present'?'‚úÖ':'‚ùå'}</span>
                                <span class="mark-date-clickable" onclick="editMarkDate('${g}',${sid},${m.id})">üìÖ ${new Date(m.date).toLocaleDateString()}</span>
                                <span class="mark-author">‚úçÔ∏è ${m.author||''}</span>
                                <button class="delete-btn" onclick="deleteMark('${g}',${sid},${m.id})">‚úï</button>
                            </div>
                        `;
                    });
                    h+='</div>';
                }
            }
            ml.innerHTML=h||'<div class="no-data">–Ω–µ—Ç</div>';
        }
        
        function renderActivities() {
            const al=document.getElementById('activitiesList');
            if(!Object.keys(data.activities||{}).length) { al.innerHTML='<div class="no-data">–Ω–µ—Ç</div>'; return; }
            let h='';
            Object.keys(data.activities).sort().reverse().forEach(d=>{
                h+=`<div class="card"><strong>${new Date(d).toLocaleDateString()}</strong>`;
                data.activities[d].forEach(a=>{ h+=`<div>üìå ${a.name}</div>`; });
                h+='</div>';
            });
            al.innerHTML=h;
        }
        
        function renderCounselors() {
            const cl=document.getElementById('counselorsList');
            if(!Object.keys(data.counselors||{}).length) { cl.innerHTML='<div class="no-data">–Ω–µ—Ç</div>'; return; }
            let h='';
            for(let g in data.counselors) {
                h+=`<div class="card"><strong>${g}</strong><div class="student-list">`;
                data.counselors[g].forEach(c=>{ h+=`<span class="staff-badge counselor">üë®‚Äçüè´ ${c.name} <button onclick="removeCounselor('${g}',${c.id})" style="background:none; border:none;">‚úï</button></span>`; });
                h+='</div></div>';
            }
            cl.innerHTML=h;
        }
        
        function renderHelpers() {
            const hl=document.getElementById('helpersList');
            if(!Object.keys(data.helpers||{}).length) { hl.innerHTML='<div class="no-data">–Ω–µ—Ç</div>'; return; }
            let h='';
            for(let g in data.helpers) {
                h+=`<div class="card"><strong>${g}</strong><div class="student-list">`;
                data.helpers[g].forEach(hp=>{ h+=`<span class="staff-badge helper">üÜò ${hp.name} <button onclick="removeHelper('${g}',${hp.id})" style="background:none; border:none;">‚úï</button></span>`; });
                h+='</div></div>';
            }
            hl.innerHTML=h;
        }
        
        function renderBooks() {
            const bl=document.getElementById('booksList');
            if(!data.books?.list.length) { bl.innerHTML='<div class="no-data">–Ω–µ—Ç –∫–Ω–∏–≥</div>'; return; }
            let fl = data.books.list;
            if(currentBookFilter!=='all') fl = fl.filter(b=>b.status===currentBookFilter);
            let h='';
            fl.forEach(b=>{
                h+=`<div class="book-item"><div><strong>${b.title}</strong> (${b.lesson})</div><span class="badge" style="background:${b.status==='available'?'green':(b.status==='completed'?'purple':'orange')}">${b.status}</span>`;
                if(currentUser?.role==='admin'){
                    h+=`<div class="book-actions"><button onclick="updateBookStatus(${b.id},'available')">üìñ</button><button onclick="updateBookStatus(${b.id},'in-progress')">üìö</button><button onclick="updateBookStatus(${b.id},'completed')">‚úÖ</button><button onclick="deleteBook(${b.id})">‚úï</button></div>`;
                }
                h+='</div>';
            });
            bl.innerHTML=h;
        }
        
        function updateGroupSelects() {
            const groups=Object.keys(data.groups||{}), opts=groups.length?groups.map(g=>`<option value="${g}">${g}</option>`).join(''):'<option value="">–Ω–µ—Ç –≥—Ä—É–ø–ø</option>';
            ['studentGroupSelect','markGroupSelect','counselorGroupSelect','helperGroupSelect'].forEach(id=>{
                let sel=document.getElementById(id);
                if(sel) sel.innerHTML='<option value="">–≤—ã–±—Ä–∞—Ç—å</option>'+opts;
            });
        }
        
        function updateStats() {
            if(currentUser?.role!=='admin') return;
            let tg=0,tm=0,tmk=0,tb=data.books?.list?.length||0,cb=data.books?.list?.filter(b=>b.status==='completed').length||0;
            for(let g in data.groups){ tg++; tm+=data.members[g]?.length||0; }
            for(let g in data.marks) for(let s in data.marks[g]) tmk+=data.marks[g][s].length;
            document.getElementById('totalGroupsStat').textContent=tg;
            document.getElementById('totalMembersStat').textContent=tm;
            document.getElementById('totalMarksStat').textContent=tmk;
            document.getElementById('totalBooksStat').textContent=tb;
            document.getElementById('completedBooksStat').textContent=cb;
        }
        
        function renderAllGroups() {
            if(!data.allUsersData) return;
            let html='';
            for(let uid in data.allUsersData){
                let ud=data.allUsersData[uid];
                for(let gn in ud.groups||{}){
                    html+=`<div class="card"><strong>${gn}</strong> (user ${uid})</div>`;
                }
            }
            document.getElementById('allGroupsList').innerHTML=html||'<div>–Ω–µ—Ç</div>';
        }

        // --- admin ---
        async function loadUsers() { if(!currentUser||currentUser.role!=='admin'||!isOnline) return; try { let res=await fetch('/api/users',{headers:{'Authorization':`Bearer ${token}`}}); if(res.ok){ let uu=await res.json(); document.getElementById('totalUsers').textContent=uu.length; } } catch(e){} }
        function cleanupData(t) { alert('cleanup '+t); }

        function closeModal() { document.getElementById('modal').classList.remove('active'); }
        function closeDetailModal() { document.getElementById('detailModal').classList.remove('active'); }

        loadFromLocalStorage();
        checkAuth();
        async function checkAuth() { if (token && isOnline) { try { let res=await fetch('/api/me',{headers:{'Authorization':`Bearer ${token}`}}); if(res.ok){ let d=await res.json(); currentUser=d.user; await loadData(); showApp(); } else localStorage.removeItem('token'); } catch { loadFromLocalStorage(); } } else if (token) loadFromLocalStorage(); }
    </script>
</body>
</html